<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>B√°o C√°o Chi Ti·∫øt - WebGIS An Giang</title>

    <!-- Th∆∞ vi·ªán Xu·∫•t Excel (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
      body {
        background-color: #525659; /* M√†u n·ªÅn x√°m chuy√™n nghi·ªáp gi·ªëng tr√¨nh xem PDF */
        margin: 0;
        padding: 30px;
        font-family: "Times New Roman", Times, serif;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* Thanh c√¥ng c·ª• ƒëi·ªÅu khi·ªÉn */
      .toolbar {
        width: 100%;
        max-width: 1000px;
        background: #323639;
        padding: 10px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        position: sticky;
        top: 10px;
        z-index: 100;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        color: white;
        transition: 0.2s;
        font-family: sans-serif;
        font-size: 13px;
      }
      .btn-excel {
        background-color: #1e88e5;
      }
      .btn-excel:hover {
        background-color: #1565c0;
      }
      .btn-print {
        background-color: #d32f2f;
      }
      .btn-print:hover {
        background-color: #b71c1c;
      }

      /* T·ªù gi·∫•y A4 */
      .a4-page {
        background: white;
        width: 100%;
        max-width: 1000px;
        min-height: 1414px; /* T·ª∑ l·ªá t∆∞∆°ng ƒë·ªëi c·ªßa kh·ªï A4 */
        padding: 60px 80px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        color: #000;
        box-sizing: border-box;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
        border-bottom: 2px solid #000;
        padding-bottom: 20px;
      }
      .title {
        font-size: 24px;
        font-weight: bold;
        margin: 0;
        text-transform: uppercase;
        color: #2e7d32;
      }
      .subtitle {
        font-size: 14px;
        margin-top: 5px;
        color: #555;
      }

      .meta-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        font-style: italic;
        font-size: 15px;
      }

      /* B·∫£ng d·ªØ li·ªáu t·ªëi ∆∞u cho h√†ng ng√†n d√≤ng */
      .table-container {
        width: 100%;
        overflow-x: auto;
        margin-top: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }
      th,
      td {
        border: 1px solid #000;
        padding: 8px;
        text-align: left;
        vertical-align: top;
        word-break: break-word;
      }
      th {
        background-color: #f2f2f2;
        text-align: center;
        font-weight: bold;
      }
      tr:nth-child(even) {
        background-color: #fafafa;
      }

      .footer {
        margin-top: 60px;
        text-align: right;
      }
      .signature-box {
        margin-top: 10px;
        padding-right: 40px;
        font-weight: bold;
      }

      /* Hi·ªáu ·ª©ng ƒëang t·∫£i */
      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #2e7d32;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Thi·∫øt l·∫≠p khi b·∫•m In (Ctrl + P) - Gi·∫•u thanh c√¥ng c·ª• v√† b√≥ng ƒë·ªï */
      @media print {
        body {
          background: white;
          padding: 0;
        }
        .toolbar {
          display: none !important;
        }
        .a4-page {
          box-shadow: none;
          padding: 0;
          max-width: 100%;
          margin: 0;
        }
        table {
          font-size: 10px;
        }
      }
    </style>
  </head>
  <body>
    <!-- M√†n h√¨nh ch·ªù khi load d·ªØ li·ªáu kh·ªïng l·ªì -->
    <div id="loading-overlay">
      <div class="spinner"></div>
      <p
        style="
          margin-top: 15px;
          font-family: sans-serif;
          font-weight: bold;
          color: #2e7d32;
        "
      >
        ƒêang tr√≠ch xu·∫•t v√† k·∫øt xu·∫•t bi·ªÉu b·∫£ng...
      </p>
    </div>

    <!-- Thanh c√¥ng c·ª• -->
    <div class="toolbar">
      <button class="btn btn-excel" id="btnExportExcel">
        üì• T·∫£i file Excel (.xlsx)
      </button>
      <button class="btn btn-print" id="btnExportPDF">
        üñ®Ô∏è In B√°o C√°o / Xu·∫•t PDF
      </button>
    </div>

    <!-- N·ªôi dung trang b√°o c√°o A4 -->
    <div class="a4-page">
      <div class="header">
        <h1 class="title">B√ÅO C√ÅO TH·ªêNG K√ä CHI TI·∫æT</h1>
        <p class="subtitle">
          H·ªá th·ªëng Th√¥ng tin ƒê·ªãa l√Ω (WebGIS) Qu·∫£n l√Ω T√†i nguy√™n t·ªânh An Giang
        </p>
      </div>

      <div class="meta-info">
        <span>Ng∆∞·ªùi l·∫≠p: Qu·∫£n tr·ªã vi√™n h·ªá th·ªëng</span>
        <span id="txtNgayLap">Ng√†y l·∫≠p: ...</span>
      </div>

      <p style="font-size: 15px">
        K·∫øt qu·∫£ tr√≠ch xu·∫•t l·ªõp d·ªØ li·ªáu:
        <b id="txtTenLop" style="color: #d32f2f; text-transform: uppercase"
          >...</b
        >
        <br />T·ªïng s·ªë ƒë·ªëi t∆∞·ª£ng ghi nh·∫≠n:
        <b id="txtTongSo" style="color: #1e88e5">0</b>
      </p>

      <div class="table-container">
        <table id="tableReport">
          <thead id="theadReport"></thead>
          <tbody id="tbodyReport"></tbody>
        </table>
      </div>

      <div class="footer">
        <div>An Giang, ng√†y ...... th√°ng ...... nƒÉm 2026</div>
        <div class="signature-box">X√ÅC NH·∫¨N C·ª¶A C∆† QUAN CHUY√äN M√îN</div>
        <div style="margin-top: 80px; padding-right: 65px">
          (K√Ω t√™n v√† ƒë√≥ng d·∫•u)
        </div>
      </div>
    </div>

    <script>
      let reportData = null;

      // Kh·ªüi ch·∫°y ngay khi trang b√°o c√°o ƒë∆∞·ª£c m·ªü l√™n
      window.onload = function () {
        // L·∫•y d·ªØ li·ªáu t·ª´ b·ªô nh·ªõ t·∫°m (sessionStorage) do trang B·∫£n ƒë·ªì g·ª≠i sang
        const raw = sessionStorage.getItem("webgis_report_data");

        if (!raw) {
          alert(
            "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu! Vui l√≤ng th·ª±c hi·ªán th·ªëng k√™ ·ªü trang b·∫£n ƒë·ªì tr∆∞·ªõc.",
          );
          window.close(); // ƒê√≥ng tab n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
          return;
        }

        // D√πng setTimeout 100ms ƒë·ªÉ tr√¨nh duy·ªát k·ªãp v·∫Ω c√°i Loading xoay xoay l√™n m√†n h√¨nh tr∆∞·ªõc khi x·ª≠ l√Ω b·∫£ng d·ªØ li·ªáu n·∫∑ng
        setTimeout(() => {
          reportData = JSON.parse(raw);
          renderReport(reportData);
        }, 100);
      };

      // H√†m ch√≠nh ƒë·ªÉ v·∫Ω b·∫£ng
      function renderReport(data) {
        document.getElementById("txtTenLop").innerText = data.layerName;
        document.getElementById("txtNgayLap").innerText =
          "Ng√†y l·∫≠p: " + data.date;
        document.getElementById("txtTongSo").innerText =
          data.features.length + " ƒë·ªëi t∆∞·ª£ng";

        const thead = document.getElementById("theadReport");
        const tbody = document.getElementById("tbodyReport");

        if (data.features.length === 0) return;

        // 1. T·∫°o ti√™u ƒë·ªÅ c·ªôt (D√πng t·ª´ ƒëi·ªÉn ƒë·ªÉ d·ªãch sang Ti·∫øng Vi·ªát)
        const firstProps = data.features[0].properties;
        const keys = Object.keys(firstProps).filter(
          (k) => !["bbox", "geom", "id"].includes(k),
        );
        const dictionary = data.dictionary || {};

        let headRow = "<tr><th>STT</th>";
        keys.forEach((k) => {
          const tenTiengViet = dictionary[k] || k;
          headRow += `<th>${tenTiengViet}</th>`;
        });
        thead.innerHTML = headRow + "</tr>";

        // 2. ƒê·ªï d·ªØ li·ªáu (Gom th√†nh 1 chu·ªói HTML l·ªõn ƒë·ªÉ render 1 l·∫ßn, gi√∫p tr√¨nh duy·ªát kh√¥ng b·ªã treo)
        let bodyHtml = "";
        data.features.forEach((f, index) => {
          let rowHtml = `<tr><td style="text-align:center;">${index + 1}</td>`;
          keys.forEach((k) => {
            const value =
              f.properties[k] !== null && f.properties[k] !== ""
                ? f.properties[k]
                : "-";
            rowHtml += `<td>${value}</td>`;
          });
          bodyHtml += rowHtml + "</tr>";
        });
        tbody.innerHTML = bodyHtml;

        // 3. Render xong th√¨ t·∫Øt m√†n h√¨nh ch·ªù ƒëi
        document.getElementById("loading-overlay").style.display = "none";
      }

      // --- S·ª∞ KI·ªÜN N√öT B·∫§M ---

      // L·ªánh In ra gi·∫•y ho·∫∑c l∆∞u PDF (G·ªçi h·ªôp tho·∫°i m·∫∑c ƒë·ªãnh c·ªßa tr√¨nh duy·ªát)
      document.getElementById("btnExportPDF").onclick = () => window.print();

      // L·ªánh xu·∫•t Excel b·∫±ng th∆∞ vi·ªán SheetJS
      document.getElementById("btnExportExcel").onclick = () => {
        if (!reportData) return;

        const dict = reportData.dictionary || {};

        // X√†o l·∫°i m·∫£ng d·ªØ li·ªáu cho ƒë√∫ng t√™n c·ªôt Ti·∫øng Vi·ªát tr∆∞·ªõc khi xu·∫•t
        const excelRows = reportData.features.map((f, i) => {
          let row = { STT: i + 1 };
          for (let k in f.properties) {
            if (!["bbox", "geom", "id"].includes(k)) {
              const headerName = dict[k] || k;
              row[headerName] = f.properties[k];
            }
          }
          return row;
        });

        // G·ªçi SheetJS t·∫°o file .xlsx
        const worksheet = XLSX.utils.json_to_sheet(excelRows);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "B√°o C√°o GIS");

        const fileName = `Bao_Cao_${reportData.layerName.replace(/\s+/g, "_")}.xlsx`;
        XLSX.writeFile(workbook, fileName);
      };
    </script>
  </body>
</html>
